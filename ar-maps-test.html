<!DOCTYPE html>
<html>
<head>
    <title>Web AR Navigasi (Metode Manual v13 - Smoothing)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <style>
      /* CSS untuk UI Debug */
      #debug-ui {
        position: fixed; top: 10px; left: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white; padding: 10px; border-radius: 5px;
        font-family: monospace; z-index: 999;
      }
      /* CSS untuk Tombol Mulai (Izin iOS) */
      #start-button {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        padding: 20px;
        background: #fff;
        border: 2px solid #000;
        border-radius: 10px;
        z-index: 10000;
      }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <button id="start-button">Mulai</button>

    <div id="debug-ui" style="display: none;">
      Menunggu data GPS & Kompas...
    </div>

    <a-scene vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true">
        
        <a-camera id="cam" 
            look-controls-enabled="false" 
            camera="far: 50000; near: 0.1">
        </a-camera>

        <a-text
            id="target-rumah"
            value="Rumah Saya (Menghitung...)"
            scale="5 5 5"
            color="#FF0000"
            position="0 0 -10" 
            look-at="[camera]"
        ></a-text>

        <a-triangle 
            id="arrow"
            visible="false"
            position="0 0.5 -3"    
            rotation="-90 0 0"     
            scale="0.5 0.5 0.5"
            color="#00FFFF"
            vertex-a="0 1 0"
            vertex-b="-1 -1 0"
            vertex-c="1 -1 0"
        ></a-triangle>

    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Ambil semua elemen penting
        const debugUI = document.getElementById('debug-ui');
        const camera = document.getElementById('cam');
        const targetRumah = document.getElementById('target-rumah');
        const arrow = document.getElementById('arrow');
        const startButton = document.getElementById('start-button');

        // --- GANTI KOORDINAT INI ---
        const targetLat = -7.5431893;
        const targetLon = 110.7698389;
        
        // Variabel state
        let currentLat = 0;
        let currentLon = 0;
        let currentAccuracy = 0;
        let currentHeading = null; // Mulai dari null untuk smoothing
        
        // Logika Tombol Mulai
        startButton.addEventListener('click', () => {
            startButton.style.display = 'none';
            debugUI.style.display = 'block';

            // Minta izin kompas di iOS
            if (typeof(DeviceOrientationEvent) !== 'undefined' && typeof(DeviceOrientationEvent.requestPermission) === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startListeners();
                        } else {
                            debugUI.innerHTML = '<span style="color: red;">Izin Kompas ditolak.</span>';
                        }
                    })
                    .catch(() => startListeners()); // Failsafe untuk Android
            } else {
                startListeners(); // Langsung mulai di Android
            }
        });

        // Fungsi untuk memulai semua sensor
        function startListeners() {
            // 1. Mulai Sensor GPS
            navigator.geolocation.watchPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLon = position.coords.longitude;
                    currentAccuracy = position.coords.accuracy;
                    updateTargetPosition();
                },
                (error) => {
                    debugUI.innerHTML = `<span style="color: red;">Error GPS: ${error.message}</span>`;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );

            // 2. Mulai Sensor Kompas (dengan Smoothing)
            const smoothingFactor = 0.1; // (0.05 = sangat mulus, 0.5 = cepat)

            window.addEventListener('deviceorientationabsolute', (event) => {
                // Ambil data mentah dan balik (dari v12)
                let rawHeading = (360 - event.alpha);

                if (currentHeading === null) {
                    // Data pertama, ambil langsung
                    currentHeading = rawHeading;
                } else {
                    // Logika smoothing untuk mengatasi "Gimbal Lock"
                    let diff = rawHeading - currentHeading;
                    if (diff > 180) { diff -= 360; }
                    if (diff < -180) { diff += 360; }

                    currentHeading += diff * smoothingFactor;
                    
                    // Normalisasi 0-360
                    currentHeading = currentHeading % 360;
                    if (currentHeading < 0) { currentHeading += 360; }
                }
                
                updateTargetPosition();
            }, true);
        }

        // Fungsi utama yang berjalan setiap sensor update
        function updateTargetPosition() {
            // Jangan lakukan apa-apa jika salah satu data belum siap
            if (currentLat === 0 || currentHeading === null) return; 

            // Hitung jarak dan arah ke target
            const distance = getDistance(currentLat, currentLon, targetLat, targetLon);
            const bearing = getBearing(currentLat, currentLon, targetLat, targetLon);
            
            // Hitung sudut relatif dari arah pandang kompas
            let relativeAngle = bearing - currentHeading;
            
            // Normalisasi sudut (-180 s/d 180)
            if (relativeAngle > 180) relativeAngle -= 360;
            if (relativeAngle < -180) relativeAngle += 360;

            // --- Logika Penempatan Objek 3D ---
            const angleInRadians = relativeAngle * (Math.PI / 180);
            const safeDistance = Math.max(1, Math.min(distance, 49000));
            
            // Hitung posisi X dan Z (dari v10)
            const posZ = -Math.cos(angleInRadians) * safeDistance;
            const posX = Math.sin(angleInRadians) * safeDistance;
            
            // Setel posisi dan teks objek
            targetRumah.setAttribute('position', `${posX} 1.6 ${posZ}`);
            targetRumah.setAttribute('value', `Rumah Saya\n${distance.toFixed(0)} m`);
            
            // --- Logika Panah Petunjuk ---
            const fovThreshold = 30; // 30 derajat dari tengah layar
            const minArrowDistance = 10; // 10 meter

            if (Math.abs(relativeAngle) > fovThreshold && distance > minArrowDistance) {
                arrow.setAttribute('visible', 'true');
                arrow.setAttribute('rotation', `-90 ${relativeAngle} 0`);
            } else {
                arrow.setAttribute('visible', 'false');
            }

            // Update UI Debug
            debugUI.innerHTML = `
              Lat: ${currentLat.toFixed(6)}<br>
              Lon: ${currentLon.toFixed(6)}<br>
              Akurasi: ${currentAccuracy.toFixed(1)} m<br>
              Kompas: ${currentHeading.toFixed(1)}°<br>
              Jarak: ${distance.toFixed(1)} m<br>
              Bearing: ${bearing.toFixed(1)}°<br>
              Rel. Sudut: ${relativeAngle.toFixed(1)}°
            `;
        }

        // --- FUNGSI MATEMATIKA (Jarak & Arah) ---
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radius Bumi (meter)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function getBearing(lat1, lon1, lat2, lon2) {
            lat1 = lat1 * Math.PI / 180; lon1 = lon1 * Math.PI / 180;
            lat2 = lat2 * Math.PI / 180; lon2 = lon2 * Math.PI / 180;
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            const brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

      });
    </script>
</body>
</html>